"use strict";angular.module("vFramework",["vClientApp.config","vClientApp.restful","vClientApp.logger","vClientApp.baseModel","vClientApp.fetchData","vClientApp.socket","vClientApp.auth"]),angular.module("vClientApp.auth",["vClientApp.logger","vClientApp.restful","vClientApp.fetchData","vClientApp.config"]).factory("$auth",["$resource","$http","$cookieStore","$rootScope","localStorageService","$logger","$q","appConfig","$fetchData","$restful",function(a,b,c,d,e,f,g,h,i,j){f.moduleName="Auth Factory";var k="user",l="token",m="lastLoginName",n="Authorization",o=function(a){b.defaults.headers.common[n]=a,f.info("_setHeaderToken","done",!0)},p=function(){b.defaults.headers.common[n]=null,f.info("_clearHeaderToken","done",!0)};return{pendingStateChange:null,clearCurrentUser:function(){this.clearUser(),f.info("clearCurrentUser","done",!0)},setCurrentUser:function(a){a.nextState="nodejs.main.home",this.setUser(a),f.info("setCurrentUser","done",!0)},getCurrentUser:function(){var a=this.getUser(),b=this.getUserRole();return a&&b&&(("admin"===b.title||"manager"===b.title)&&(a.nextState="nodejs.admin"),"user"===b.title&&(a.nextState="nodejs.main.home"),("kitchen"===b.title||"bar"===b.title)&&(a.nextState="bell.monitor-bar.monitor")),f.info("getCurrentUser","done",!0),a},clearUser:function(){e.remove(k)},setUser:function(a){e.set(k,JSON.stringify(a))},getUser:function(){var a=e.get(k);return a?a:null},setToken:function(a){a?(o(a),e.set(l,a)):(o(null),e.set(l,null))},getToken:function(){return e.get(l)},clearToken:function(){p(),e.set(l,null)},setHeaderToken:function(){var a=this.getToken();o(a?a:null),f.info("setHeaderToken","done",!0)},getHeaderToken:function(){var a=b.defaults.headers.common[n];return a?a:null},assignSocketIoEvent:function(a){window.socketIo.on("connect",function(){f.info("connectSocketIo","established a working and authorized connection success",!0),a(!0)}),window.socketIo.on("disconnect",function(){f.info("connectSocketIo","disconnect by some reason",!0)}),window.socketIo.on("error",function(b){f.error("connectSocketIo","error",b),a(!1)})},connectSocketIo:function(a){f.info("connectSocketIo","starting",!0);var b=this.getHeaderToken();window.socketIo?(window.socketIo.disconnect(),f.info("connectSocketIo","disconnect",!0),window.socketIo=window.io.connect(h.apiHost+"/?token="+b,{"force new connection":!0}),f.info("connectSocketIo","re-connect",!0),window.socketIo.emit("user:connect",{userId:this.getUserId()}),this.assignSocketIoEvent(a)):(f.info("connectSocketIo","connect first time",!0),window.socketIo=window.io.connect(h.apiHost+"/?token="+b,{"force new connection":!0}),window.socketIo.emit("user:connect",{userId:this.getUserId()}),this.assignSocketIoEvent(a))},resolvePendingState:function(a){var b="resolvePendingState";f.info(b,"starting",!0);var c=g.defer(),d=this,e=d.pendingStateChange;return a.success(function(a){a.success?(d.setCurrentUser(a.user),void 0===e.to.accessLevel||d.authorize(e.to.accessLevel)?(f.info(b,"success and authorized",!0),c.resolve()):(f.info(b,"success BUT Unauthorized",!0),c.reject("unauthorized"))):(c.reject("401"),f.info(b,"error",a.message))}).error(function(a,d){c.reject(d.toString()),f.info(b,"error",a)}),d.pendingStateChange=null,c.promise},register:function(a,c){b({method:"POST",data:a,url:h.apiHost+h.registerRouterServer}).success(function(a){c(null,a)}).error(function(a){c(a,null)})},getUserInfoById:function(a,b){j.get({table:h.loginTableName,id:a},function(a){a.success?b(null,a.data):b(a.message,null)})},login:function(a,c,e){var g=this;d.crudProcessing=!0,b({method:"POST",data:{username:a,password:c},url:h.apiHost+h.loginRouteServer}).success(function(a){f.info("login","success",!0);var b=a.user,c=a.token;g.setCurrentUser(b),g.setToken(c),g.setLastLoginName(),g.pendingStateChange=null,e(null,a)}).error(function(a){d.crudProcessing=!1,d.loginError=a,e(a,null)})},logout:function(a){var c=this;d.logoutProcessing=!0,b({method:"POST",url:h.apiHost+h.logoutRouterServer}).success(function(){f.info("logout","success",!0),c.clearCurrentUser(),c.clearToken(),window.socketIo&&window.socketIo.disconnect(),f.info("Authorize","logout",!0),f.info("Authorize","logout",c.getToken()),d.logoutProcessing=!1,a(!0)}).error(function(b){f.error("logout","error",b),f.info("Authorize","logout",!1),d.logoutProcessing=!1,a(!1)})},setLastLoginName:function(){e.set(m,this.getUserName())},getLastLoginName:function(){return e.get(m)},getUserId:function(){var a=this.getUser();return a?a.id:""},getUserName:function(){var a=this.getUser();return a?a.name:""},getUserFullName:function(){var a=this.getUser();return a?a.fullname:""},getUserRole:function(){var a=this.getUser();return a?a.role:null},getUserSite:function(){var a=this.getUser();return a&&a.site?a.site:null},authorize:function(a){var b=this.getUserRole();if(null!==b){var c=a.bitMask<=b.bitMask;return c}return!1},isLogin:function(){var a=this.getUserRole();return a?!0:!1}}}]),angular.module("vClientApp.baseModel",["vClientApp.logger","vClientApp.restful"]).factory("$baseModel",["$resource","$http","$cookieStore","$rootScope","$logger","$window","$restful",function(a,b,c,d,e,f,g){e.moduleName="BaseModel Factory";var h=function(a,b){this.omitFields=["omitFields","tableName","busy","cid","acceptSocket"],this.tableName=a,this.busy=!1,this.acceptSocket=!1,this.socketData={};var c=this;angular.extend(c,b)};return h.prototype.save=function(a){e.info("save model","start",!0);var b=this,c=!1;if(!b.busy){b.busy=!0,c=b.id?!1:!0;var d=window._.omit(b,b.omitFields);c?(e.info("$restful save","start",!0),g.save({table:b.tableName},d,function(c){if(b.busy=!1,c.success&&(b._id=c.data._id,b.id=b._id,b.acceptSocket)){console.log("$restful save","acceptSocket",!0);var d={table:b.tableName,action:"create",id:c.data._id};b.socketData&&(d=window._.extend(d,b.socketData)),window.socketIo.emit("socket",d)}e.info("create new model","resp",c),a&&a(c.success?null:c.message,c.data)})):(e.info("$restful put","start",!0),g.put({table:b.tableName,id:b.id},d,function(c){if(b.busy=!1,c.success&&b.acceptSocket){console.log("$restful put","acceptSocket",!0);var d={table:b.tableName,action:"update",id:c.data.id};b.socketData&&(d=window._.extend(d,b.socketData)),window.socketIo.emit("socket",d)}e.info("update existing model","resp",c),a&&a(c.success?null:c.message,c.data)}))}},h.prototype.destroy=function(a){var b=this;b.busy||(b.busy=!0,g.delete({table:b.tableName,id:b.id},function(c){if(b.busy=!1,c.success){if(b.acceptSocket){var d={table:b.tableName,action:"delete",id:c.data.id};b.socketData&&(d=window._.extend(d,b.socketData)),window.socketIo.emit("socket",d)}a&&a(null,c.data)}else a&&a(c.message,null);e.info("delete model","resp",c)}))},h}]),angular.module("vClientApp.fetchData",["vClientApp.logger","vClientApp.restful","vClientApp.baseModel"]).factory("$fetchData",["$baseModel","$restful","$q","$collection","$logger","dataStorage",function(a,b,c,d,e,f){e.moduleName="Fetch Data Factory";var g;return g={getData:function(e,f,g,h,i){var j,k,l,m,n=c.defer(),o=d,p=null;return p=o.getInstance(),j=f||0,k=g||1e3,l=JSON.stringify(h)||null,m=JSON.stringify(i)||null,b.get({table:e,start:j,limit:k,filter:l,sort:m},function(b){if(b.success){var c=b.data;angular.forEach(c,function(b){var c=new a(e,b);p.add(c)}),p.total=b.total,n.resolve(p)}else n.reject(b.message)},function(a){n.reject(a)}),n.promise},getDataId:function(d,g,h){var i=c.defer();return angular.isString(d)&&angular.isString(g)?h&&!angular.isUndefined(f[h])&&f[h].size()>0?(i.resolve(f[h].get(g)),e.info("","Get data from Storage",f[h].get(g))):(h&&console.log("Name",h+" Storage false or Storage null"),b.get({table:d,id:g},function(b){var c=new a(d,b.data);i.resolve(c),e.info("","Get data from server",c)},function(a){i.reject(a)})):i.reject("tableName or id required String"),i.promise}}}]),angular.module("vClientApp.logger",["vClientApp.config"]).factory("$logger",["appConfig",function(a){var b=function(a){for(var b="",c=0;c<a.length;c++){var d=a[c];b+=angular.isString(d)?d:JSON.stringify(d,null,"	")+" "}return b},c=function(){var a=new Date,b=a.getFullYear()+"/"+(a.getMonth()+1)+"/"+a.getDate(),c=a.toLocaleTimeString(),d=b+" "+c;return d},d=function(d,e){if(a.disableLog[d])return!1;var f=" - ",g=": ",h=this.moduleName,i=e[0],j=e[1];e.splice(0,1),e.splice(0,1);var k=b(e),l=c()+f+h+f+i+f+j+g+k;console[this.functionName[d]](l)};return{moduleName:"NO MODULE",functionName:{info:"info",error:"error",debug:"debug"},info:function(){var a=Array.prototype.slice.call(arguments,0);angular.bind(this,d,"info",a)()},error:function(){var a=Array.prototype.slice.call(arguments,0);angular.bind(this,d,"error",a)()},debug:function(){var a=Array.prototype.slice.call(arguments,0);angular.bind(this,d,"debug",a)()}}}]),angular.module("vClientApp.restful",["vClientApp.logger","vClientApp.config"]).service("$restful",["$resource","appConfig",function(a,b){return a(b.apiHost+"/:api/:table/:id",{api:"api",id:"@id",table:"@table"},{get:{method:"GET"},save:{method:"POST",params:{}},put:{method:"PUT",params:{}},query:{method:"GET",isArray:!0},"delete":{method:"DELETE",params:{}}})}]),angular.module("vClientApp.socket",[]).factory("$socket",function(a){var b=window.socketIo;return{on:function(c,d){b.on(c,function(){var c=arguments;a.$apply(function(){d.apply(b,c)})})},emit:function(c,d,e){b.emit(c,d,function(){var c=arguments;a.$apply(function(){e&&e.apply(b,c)})})}}});